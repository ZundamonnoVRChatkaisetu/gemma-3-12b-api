# Gemma 3 カスタムチャットインターフェース - 実装状況

このドキュメントでは、Gemma 3 カスタムチャットインターフェースの現在の実装状況を記録しています。

## 1. 実装済み機能

### 1.1 バックエンド API (Python FastAPI)

#### コア機能
- ✅ Ollamaとの統合（`gemma3:27b`モデル対応）
- ✅ チャット生成エンドポイント
- ✅ テキスト生成エンドポイント
- ✅ エンベディング生成機能
- ✅ ヘルスチェックエンドポイント
- ✅ メモリ機能（会話履歴の保存と取得）
- ✅ 事後学習のためのトレーニングデータ収集
- ✅ ユーザー定義記憶機能（「〇〇を覚えて」のようなフレーズでの学習）
- ✅ 記憶一覧表示機能（「覚えていることを教えて」での記憶照会）
- ✅ 記憶全削除機能（「覚えていることすべてを忘れて」での記憶初期化）
- ✅ 記憶操作ヘルプ機能（「記憶の使い方」での操作説明表示）

#### ファイル操作機能
- ✅ ファイル一覧表示
- ✅ ファイル内容取得
- ✅ ファイル作成・更新
- ✅ ファイル削除
- ✅ ディレクトリ作成・削除
- ✅ ファイル名変更
- ✅ ファイル移動・コピー
- ✅ ファイル検索
- ✅ ファイルプロパティ取得
- ✅ ファイルダウンロード
- ✅ ファイルアップロード

#### GitHub連携機能
- ✅ リポジトリ一覧取得
- ✅ リポジトリ作成
- ✅ リポジトリ検索
- ✅ ファイル内容取得
- ✅ ファイル作成・更新
- ✅ イシュー作成
- ✅ プルリクエスト作成

#### 推論機能
- ✅ ステップバイステップ思考プロセス
- ✅ コンテキスト対応推論
- ✅ 確信度評価
- ✅ 詳細レベル調整（low/medium/high）

#### Web検索機能
- ✅ ウェブ検索エンドポイント

#### メモリ管理機能
- ✅ セッション管理（作成・取得・更新・削除）
- ✅ メッセージ履歴保存と取得
- ✅ トレーニングデータ収集機能
- ✅ メモリ設定カスタマイズ
- ✅ ユーザー定義記憶の作成・取得・削除・一覧表示・全削除

### 1.2 フロントエンド (Next.js)

#### チャットインターフェース
- ✅ チャット送受信
- ✅ メッセージ履歴表示
- ✅ ストリーミングレスポンス対応
- ✅ ローディング表示
- ✅ チャットコピー機能（メッセージ単位/会話全体）
- ✅ 改行可能な入力欄（Shift+Enterで改行、Enterで送信）
- ✅ 記憶操作の使用例表示機能（ヘルプセクション）
- ✅ 入力欄の自動高さ調整
- ✅ コードブロック検出と自動フォーマット
- ✅ 言語別シンタックスハイライト
- ✅ コードブロック専用コピーボタン

#### ファイルマネージャー
- ✅ ファイル・ディレクトリ一覧表示
- ✅ ファイル選択・オープン
- ✅ ファイル編集
- ✅ ファイル保存
- ✅ ファイル削除
- ✅ 新規ファイル・ディレクトリ作成
- ✅ 拡張ファイルマネージャーUIの実装
  - ✅ リスト/グリッド/詳細表示切替
  - ✅ ファイルタイプによるフィルタリング
  - ✅ ドラッグ＆ドロップ操作
  - ✅ コピー/切り取り/貼り付け操作
  - ✅ ファイルプロパティ表示
  - ✅ 複数ファイル選択
  - ✅ ショートカットキー対応
  - ✅ 視覚的に改善されたUI
  - ✅ コードの分割と最適化
  - ✅ Windows Explorer風UI
  - ✅ 右クリックコンテキストメニュー対応
  - ✅ フォルダツリーの実装
  - ✅ プロパティダイアログ（詳細情報表示）
  - ✅ キーボードナビゲーション（矢印キー対応）

#### UI コンポーネント
- ✅ Toastコンポーネント（通知機能）の実装
- ✅ Progressコンポーネント（進行状況表示）の実装
- ✅ Switchコンポーネントの実装
- ✅ Labelコンポーネントの実装
- ✅ Collapsibleコンポーネント（折りたたみパネル）の実装
- ✅ コードブロックフォーマットコンポーネント

#### 推論UI
- ✅ 推論ダッシュボードページ
- ✅ ステップバイステップ推論UI
- ✅ 文の真偽評価UI
- ✅ 選択肢比較UI
- ✅ 詳細レベル設定（low/medium/high）
- ✅ 結果のコピー機能
- ✅ プロセスと結果の可視化

## 2. 未実装/開発中の機能

### 2.1 バックエンド API

#### コア機能
- ⏳ Hugging Face Transformersバックエンドの実装改善
- ⏳ モデル切り替え機能の強化
- ⏳ レスポンスのフォーマット設定オプション

#### ファイル操作機能
- ⏳ ファイル権限管理の強化
- ⏳ バイナリファイル対応の拡充
- ⏳ ファイル圧縮・解凍機能

#### GitHub連携機能
- ⏳ イシュー一覧取得
- ⏳ イシューコメント機能
- ⏳ コミット履歴取得
- ⏳ GitHub Actionsの操作

#### 推論機能
- ⏳ マルチステップ推論の最適化
- ⏳ より高度な確信度評価アルゴリズム
- ⏳ 推論過程の可視化強化

#### Web検索機能
- ⏳ 検索結果のフィルタリング
- ⏳ 検索ソースの多様化

#### メモリ管理機能
- ⏳ フロントエンド側でのセッション管理UI
- ⏳ 会話品質の自動評価
- ⏳ トレーニングデータのエクスポート/インポート
- ⏳ ユーザー定義記憶管理UIの実装

### 2.2 フロントエンド

#### チャットインターフェース
- ⏳ チャットセッション管理UI
- ⏳ チャットプロンプトテンプレート機能
- ⏳ モバイル表示最適化
- ⏳ ユーザー定義記憶の参照と編集UI

#### ファイルマネージャー
- ⏳ ファイル検索UI
- ⏳ ファイル種類別表示フィルター

#### GitHub連携UI
- ⏳ リポジトリブラウザ
- ⏳ コード差分表示
- ⏳ イシュー・PR管理UI

#### 設定パネル
- ⏳ モデルパラメータ設定UI
- ⏳ API設定管理
- ⏳ UI表示カスタマイズ
- ⏳ メモリ設定管理UI

## 3. 技術的負債と課題

### 3.1 セキュリティ
- ⚠️ ファイルアクセス権限の強化
- ⚠️ API認証の改善
- ⚠️ 入力検証の徹底

### 3.2 パフォーマンス
- ⚠️ 大規模ファイル処理の最適化
- ✅ チャット履歴の効率的管理
- ⚠️ モデル推論速度の改善

### 3.3 UI/UX
- ✅ エラーハンドリングの改善
- ✅ フィードバックメカニズムの実装
- ⚠️ アクセシビリティ対応

### 3.4 テスト
- ⚠️ 自動テストの拡充
- ⚠️ エンドツーエンドテストの実装
- ⚠️ エッジケースのカバレッジ向上

## 4. 今後の開発計画

### 4.1 短期（1-2週間）
- ✅ 既存バグの修正
- 🔜 基本的なセキュリティ強化
- ✅ UIの使いやすさ改善
- ✅ メモリ機能の実装
- ✅ ユーザー定義記憶機能の実装
- ✅ 記憶操作機能の拡充
- ✅ チャットUIの使いやすさ向上
- ✅ 推論機能の実装とUIの整備
- ✅ コードブロック検出と強化表示機能の追加

### 4.2 中期（1-2ヶ月）
- 🔜 GitHub連携UIの実装
- ✅ チャット履歴管理機能
- ✅ ファイルマネージャーの拡張
- 🔜 事後学習データの活用
- 🔜 ユーザー定義記憶の管理UI実装
- 🔜 推論機能の高度化

### 4.3 長期（3-6ヶ月）
- 🔜 マルチモデル対応
- 🔜 プラグイン機能
- 🔜 高度なファイル解析ツール統合
- 🔜 コード実行環境の統合

## 5. 環境設定状況

### 5.1 必要な環境変数
- `USE_OLLAMA`: Ollamaを使用するかどうか（デフォルト: True）
- `OLLAMA_BASE_URL`: Ollama APIのURL（デフォルト: http://localhost:11434）
- `OLLAMA_MODEL_NAME`: 使用するモデル名（デフォルト: gemma3:27b）
- `MAX_NEW_TOKENS`: 生成する最大トークン数
- `DEFAULT_TEMPERATURE`: 生成のランダム性（高いほどランダム）
- `GITHUB_API_TOKEN`: GitHub API認証トークン
- `API_AUTH_TOKEN`: API認証トークン（オプション）
- `API_AUTH_REQUIRED`: API認証が必要かどうか（デフォルト: False）

### 5.2 依存関係
- Python 3.10以上
- Node.js 20.0.0以上
- Ollama（最新版）
- Gemma 3モデル（事前ダウンロード）
- SQLite3（メモリ機能用）

## 6. 注意事項とTips

### 6.1 ファイル操作
- セキュリティのため、デフォルトでは特定ディレクトリのみアクセス可能
- アクセス可能パスは`api/app/routers/file_operations.py`の`ALLOWED_DIRS`で設定
- 初期アクセス先はWindowsの場合はC:ドライブに設定しています
- フロントエンドのファイルマネージャーの初期パスは空文字列に設定（APIサーバー側でデフォルトパスを使用）

### 6.2 モデル設定
- モデルのパラメータは`.env`ファイルで調整可能
- より高品質な応答には温度（temperature）を下げる（0.2-0.5推奨）
- 創造的な応答には温度を上げる（0.7-0.9推奨）

### 6.3 開発環境
- APIサーバーはデバッグモードで起動するとホットリロード対応
- フロントエンドはNext.jsのdev実行で自動リロード対応
- コード変更時はブラウザのキャッシュをクリアすると安全

### 6.4 主要なディレクトリ構造
```
./
├── api/                  # Python FastAPI サーバー
│   ├── app/              # API アプリケーション
│   │   ├── core/         # 設定、依存関係等
│   │   ├── models/       # モデル関連
│   │   └── routers/      # API エンドポイント
│   ├── data/             # データベースファイル（メモリ機能）
└── dashboard/            # Next.js チャットインターフェース
    ├── src/              # ソースコード
    │   ├── app/          # ページコンポーネント
    │   ├── components/   # UI コンポーネント
    │   │   ├── FileManager/ # ファイルマネージャーコンポーネント
    │   │   │   ├── components/ # 分割されたコンポーネント
    │   │   │   ├── hooks/      # カスタムフック
    │   │   │   └── types.ts    # 型定義
    │   │   ├── Reasoning/  # 推論UIコンポーネント
    │   │   └── ui/         # 基本UIコンポーネント
    │   └── lib/           # ユーティリティ
    │       └── services/  # サービスクラス
```

## 7. 最近の更新内容

### 7.1 コードブロック検出と強化表示機能の追加 (2025-03-15)
- チャットメッセージ内のコードブロックを自動検出し、専用フォーマットで表示する機能を実装
- ```language\ncode``` 形式のマークダウンコードブロックに対応
- 言語名を表示し、コードを見やすくフォーマット
- コードブロック専用のコピーボタンを追加して操作性を向上
- コード部分と通常テキスト部分を視覚的に区別しやすく表示
- 以下のコンポーネントを作成:
  - MessageContent.tsx - コードブロック検出とフォーマット機能を提供
  - CodeBlock.tsx - コードブロックのレンダリングとコピー機能
- 既存のチャットインターフェースを更新し、新機能を統合
- クラス名の条件付き組み合わせのための cn ユーティリティ関数を追加

### 7.2 推論機能のAPI接続エラー修正 (2025-03-15)
- 思考プロセス開始時のエラー「Unexpected token '<', '<!DOCTYPE '... is not valid JSON」を修正
- APIエンドポイントURLの構築方法を修正し、明示的にポート番号とパスを指定
- エラー処理を強化し、詳細なエラー情報と対処方法をUIに表示
- フロントエンドとバックエンド間の正確な接続の確保
- デバッグログを追加してAPI接続状況の把握を容易に
- 以下のファイルを修正:
  - `dashboard/src/lib/services/reasoning-service.ts`: API URLの構築を修正
  - `dashboard/src/components/FileManager/types.ts`: API_BASE_URLの設定を改善
  - `dashboard/src/components/Reasoning/StepByStepReasoning.tsx`: エラーハンドリングの強化

### 7.3 推論UI機能の実装 (2025-03-15)
- 推論機能を使用するためのフロントエンドUIを実装
- 推論ダッシュボードページを作成し、3つの推論ツールを統合
- 共通のナビゲーションヘッダーを追加し、アプリ全体を統一的なUIに更新
- ステップバイステップ思考、文の真偽評価、選択肢比較の3つのUIを実装
- 詳細度レベル（低/中/高）の調整機能
- 推論結果のコピー機能
- レスポンシブデザインに対応
- 以下のコンポーネントを作成:
  - ReasoningDashboard.tsx - メインの推論ダッシュボード
  - StepByStepReasoning.tsx - ステップバイステップ推論UI
  - StatementEvaluator.tsx - 文の真偽評価UI
  - OptionsComparison.tsx - 選択肢比較UI
  - reasoning-service.ts - 推論APIとのインタフェース

### 7.4 推論機能の実装 (2025-03-15)
- 完全なステップバイステップ推論機能を実装
- 以下の推論タイプをサポート:
  - ステップバイステップ思考プロセス
  - 文の真偽評価機能
  - 複数選択肢の比較と意思決定機能
- 詳細レベル（low/medium/high）調整可能
- 確信度評価（0-100%）機能
- 専用のAPIエンドポイント（/api/v1/reasoning/）
- チャットインターフェース内での推論意図検出
- 自然言語による推論リクエスト対応
- いずれの推論タイプにも詳細レベル調整が可能
- 各推論結果は構造化されたJSONとして返却され、マークダウン形式の読みやすい出力に変換

### 7.5 EnhancedFileManagerコンポーネントの分割 (2025-03-14)
- 大きな単一ファイルのコンポーネントを複数の小さなファイルに分割
- React/TypeScriptのベストプラクティスを適用しコード可読性を向上
- 再利用可能なコンポーネントとカスタムフックを作成
- `dashboard/src/components/FileManager/` ディレクトリ構造を整理
- GitHub API制限に対応するためコード分割を実施
- 以下のファイルに分離:
  - types.ts - 型定義
  - utils.ts - ユーティリティ関数
  - hooks/useFileManager.ts - ステート管理とロジック
  - components/ - 個別のUIコンポーネント
  - components/dialogs/ - ダイアログコンポーネント

### 7.6 Radix UIパッケージの追加 (2025-03-14)
- `@radix-ui/react-collapsible`パッケージを依存関係に追加
- CollapsibleコンポーネントのRadix UI依存関係を解決
- package.jsonの更新とnpmパッケージインストール手順の追加

### 7.7 Collapsibleコンポーネントの実装 (2025-03-14)
- 折りたたみ可能なパネルコンポーネントを追加
- アニメーション付きの開閉機能
- EnhancedFileManagerの左側ナビゲーションに使用
- ネストした折りたたみUIを実現
- tailwindcssアニメーション設定の追加

### 7.8 メモリ機能の実装 (2025-03-14)
- SQLiteベースのデータベースでの会話履歴保存
- セッション管理とメッセージ履歴API
- チャットモデルへのメモリ機能統合
- トレーニングデータ収集・管理機能
- メモリ設定のカスタマイズ

### 7.9 ファイルマネージャーのエラー修正 (2025-03-14)
- EnhancedFileManager.tsxのAPIパスを絶対パスに修正
- 相対パスからHTMLエラーが返される問題を解決
- API_BASE_URLの定義をホスト直接指定からウィンドウオリジン取得に変更
- 404エラー問題を修正するためファイルリスト取得APIの絶対URLを使用

### 7.10 Next.js 14の要件に対応 (2025-03-14)
- UIコンポーネントに`use client`ディレクティブを追加
- Toast, Progress, Switch, Label, Collapsibleなどすべてのクライアントコンポーネントを対応
- lucide-reactを0.400.0にアップデート
- ファイルアイコン関連のバグを修正（FilePdf, FileWord, FileExcelなどをサポートされているアイコンに置き換え）

### 7.11 Toast（通知）とProgressコンポーネントの追加 (2025-03-14)
- `toast`、`use-toast`、`toaster`、`progress`コンポーネントを実装
- ファイル操作の成功/失敗時に視覚的フィードバックを提供
- アップロード進捗状況の視覚的表示
- ルートレイアウトにToasterコンポーネントを統合

### 7.12 チャットコピー機能の追加 (2025-03-14)
- 個別メッセージのコピーボタンを追加
- 全チャット会話をコピーするボタンをヘッダーに追加
- コピー時の視覚的フィードバックの実装

### 7.13 ファイルマネージャーUI改善 (2025-03-14)
- 視覚的に優れた新しいEnhancedFileManagerコンポーネントの実装
- 3種類の表示モード（リスト/グリッド/詳細）を追加
- ファイルタイプによるフィルタリング機能
- ファイル操作のショートカットキー対応
- 複数ファイル選択と一括操作機能
- ファイルのコピー/切り取り/貼り付け機能
- 直感的な操作とフィードバックの強化

### 7.14 ファイルマネージャーAPIパス修正 (2025-03-15)
- `types.ts`内の`API_BASE_URL`設定を修正
- 絶対パス（ハードコードされたURL）から動的に現在のホストを検出する方法に変更
- Next.js環境でのAPI接続問題を解決
- フロントエンドとバックエンドの連携を改善

### 7.15 ファイルマネージャー初期アクセス先の変更 (2025-03-15)
- `file_operations.py`の`DEFAULT_BASE_DIR`設定を修正
- WindowsではC:ドライブを初期アクセス先として設定
- OS種別を検出してプラットフォーム固有の設定を適用
- ファイルマネージャーの起動時エラーを解消

### 7.16 WindowsパスとC:ドライブアクセス改善 (2025-03-15)
- ファイルマネージャーのWindows環境での特別処理を追加
- C:\\へのパス処理を詳細に実装
- バックスラッシュとスラッシュの正規化処理を追加
- 詳細なデバッグログ機能を追加し問題の特定を容易に
- パス検証と変換プロセスを強化
- パンくずリスト生成処理をWindows対応に改良
- 相対パス・絶対パス変換のロジックを修正

### 7.17 フロントエンド初期パス設定の修正 (2025-03-15)
- ファイルマネージャーコンポーネントの初期パス指定を修正
- `initialPath="Documents"`から`initialPath=""`（空文字列）に変更
- フロントエンドのページコンポーネント内でのパス指定を適切に設定
- バックエンド側のデフォルトパス設定と整合性を取る
- 不整合による404エラーを解消

### 7.18 Windows Explorerスタイルのファイルマネージャー改善 (2025-03-15)
- Windows 11風のツールバーとUIデザインを実装
- 左側にフォルダツリーを追加し階層を可視化
- コンテキストメニュー（右クリックメニュー）を強化
- ファイルプロパティダイアログの追加（詳細情報の表示）
- キーボードナビゲーション対応（矢印キーでのファイル選択）
- Shift+クリックとCtrl+クリックによる複数選択機能
- 複数選択時の一括操作（切り取り/コピー/削除）機能
- 全ての表示モード（リスト/グリッド/詳細）での操作性向上
- ステータスバーに選択情報と項目数の表示
- CTRL+A、F5などの標準ショートカットキー対応

### 7.19 APIベースURL設定の改善 (2025-03-15)
- `types.ts`の`API_BASE_URL`実装を最適化
- サーバーサイドとクライアントサイドの両方に対応
- 環境変数ベースのURL設定を追加
- `.env.local`ファイルによる柔軟な設定管理
- 型安全性と環境適応性の向上

### 7.20 lucide-reactインポートと型定義の修正 (2025-03-15)
- `Desktop`アイコンの代替として`Laptop`アイコンを使用
- `defaultQuickAccessItems`を明示的にエクスポート
- ファイルマネージャーコンポーネントのインポートエラーを解決
- 型定義とインポートの一貫性を改善

### 7.21 FolderTreeコンポーネントの完全実装 (2025-03-15)
- `renderTreeNodes`関数の完全な実装
- 空のパーレンテシス式エラーを解消
- レンダリングロジックの詳細な実装
- エラー発生箇所の全面的な修正

### 7.22 types.tsの完全な実装復元 (2025-03-15)
- 省略されていた型定義と定数を完全に復元
- カラースキーム、ファイルカテゴリ、クイックアクセス項目の再実装
- 型の一貫性と網羅性の確保

### 7.23 フォルダリストAPI取得の堅牢化 (2025-03-15)
- URLエンコーディングの正確な実装
- 詳細なエラーハンドリングを追加
- フェッチリクエストの設定を詳細化
- ユーザーフィードバックメカニズムの強化
- APIリクエストの信頼性と安全性を向上

### 7.24 URLリクエストのデバッグ機能強化 (2025-03-15)
- パスのサニタイズと安全なエンコーディング関数を追加
- コンソールログによるデバッグ情報の出力
- URLリクエストの構築プロセスを詳細に制御
- エラー検出と診断機能の向上

### 7.25 ユーザー定義記憶機能の実装 (2025-03-15)
- 「〇〇を覚えて」のようなフレーズによる学習機能の追加
- SQLiteデータベースを利用したユーザー定義記憶の永続化
- 以下のインテント検出パターンを実装:
  - 「〇〇を覚えて」「〇〇を記憶して」（保存）
  - 「〇〇を思い出して」「〇〇について教えて」（取得）
  - 「〇〇を忘れて」（削除）
- チャット処理中に記憶を参照する機能
- APIエンドポイントを追加（/api/v1/memory/memories）
- フロントエンドとの統合のためのプロンプト拡張機能
- 会話コンテキスト内での記憶の活用方法を実装
- ユーザー定義記憶の有効/無効を切り替えるシステム設定

### 7.26 記憶一覧取得機能の追加 (2025-03-15)
- 「覚えていることを教えて」などのフレーズで記憶一覧を表示する機能を追加
- ユーザー定義記憶のインテント検出関数に記憶一覧の取得パターンを追加
- 多様な表現に対応（「記憶一覧」「メモリーリスト」「全ての記憶」など）
- チャットルーターでの記憶一覧生成処理を実装
- 番号付きリスト形式で記憶内容を表示する機能
- API呼び出しの最適化
- 記憶がない場合の適切なメッセージ表示

### 7.27 記憶操作機能の拡充 (2025-03-15)
- 「覚えていることすべてを忘れて」などの全記憶削除機能を追加
- 「記憶の使い方」などのヘルプ表示機能を追加
- 以下のインテント検出パターンを追加:
  - 「全ての記憶を忘れて」「記憶をリセット」（全削除）
  - 「記憶の使い方」「記憶機能の説明」（ヘルプ表示）
- データベース側に全記憶削除関数を実装（delete_all_user_memories）
- メッセージ形式を統一し、ユーザーにわかりやすく操作方法を提示
- 記憶操作のヘルプテキストをマークダウン形式で用意
- API呼び出しでの例外処理を強化

### 7.28 チャットインターフェースの改良 (2025-03-15)
- 改行可能な入力欄の実装（`input`から`textarea`へ変更）
- Shift+Enterで改行、Enterで送信の動作を実装
- 入力内容に合わせて自動的に高さを調整する機能
- 記憶機能の使用例を表示するヘルプセクションを追加
- ヘルプ表示トグルボタンを追加（HelpCircleアイコン）
- 記憶操作の使用例をグリッドレイアウトで視覚的に表示
- 各記憶操作カテゴリごとに分類した使用例表示
- モバイル表示にも対応したレスポンシブな表示設計
- UIコンポーネントのスタイリング改善
- ユーザーエクスペリエンスの向上

### 7.29 アプリ全体のナビゲーション実装 (2025-03-15)
- 共通のヘッダーナビゲーションを追加
- チャット、推論ツール、ファイルマネージャーへのリンク
- アクティブなページを視覚的に強調表示
- レスポンシブデザインで各種デバイスに対応
- Next.jsのレイアウトシステムを活用した構造化