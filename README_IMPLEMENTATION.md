# Gemma 3 カスタムチャットインターフェース - 実装状況

このドキュメントでは、Gemma 3 カスタムチャットインターフェースの現在の実装状況を記録しています。

## 1. 実装済み機能

### 1.1 バックエンド API (Python FastAPI)

#### コア機能
- ✅ Ollamaとの統合（`gemma3:27b`モデル対応）
- ✅ チャット生成エンドポイント
- ✅ テキスト生成エンドポイント
- ✅ エンベディング生成機能
- ✅ ヘルスチェックエンドポイント
- ✅ メモリ機能（会話履歴の保存と取得）
- ✅ 事後学習のためのトレーニングデータ収集
- ✅ ユーザー定義記憶機能（「〇〇を覚えて」のようなフレーズでの学習）
- ✅ 記憶一覧表示機能（「覚えていることを教えて」での記憶照会）
- ✅ 記憶全削除機能（「覚えていることすべてを忘れて」での記憶初期化）
- ✅ 記憶操作ヘルプ機能（「記憶の使い方」での操作説明表示）

#### ファイル操作機能
- ✅ ファイル一覧表示
- ✅ ファイル内容取得
- ✅ ファイル作成・更新
- ✅ ファイル削除
- ✅ ディレクトリ作成・削除
- ✅ ファイル名変更
- ✅ ファイル移動・コピー
- ✅ ファイル検索
- ✅ ファイルプロパティ取得
- ✅ ファイルダウンロード
- ✅ ファイルアップロード

#### GitHub連携機能
- ✅ リポジトリ一覧取得
- ✅ リポジトリ作成
- ✅ リポジトリ検索
- ✅ ファイル内容取得
- ✅ ファイル作成・更新
- ✅ イシュー作成
- ✅ プルリクエスト作成

#### 推論機能
- ✅ ステップバイステップ思考プロセス
- ✅ コンテキスト対応推論
- ✅ 確信度評価
- ✅ 詳細レベル調整（low/medium/high）
- ✅ 高度な確信度評価アルゴリズム（0-100%のスケール、確信度の言語的表現対応）
- ✅ 推論プロンプトの大幅強化によるより質の高い推論
- ✅ 堅牢なJSON解析処理（不正な形式でも適切に処理）

#### Web検索機能
- ✅ ウェブ検索エンドポイント

#### メモリ管理機能
- ✅ セッション管理（作成・取得・更新・削除）
- ✅ メッセージ履歴保存と取得
- ✅ トレーニングデータ収集機能
- ✅ メモリ設定カスタマイズ
- ✅ ユーザー定義記憶の作成・取得・削除・一覧表示・全削除

### 1.2 フロントエンド (Next.js)

#### チャットインターフェース
- ✅ チャット送受信
- ✅ メッセージ履歴表示
- ✅ ストリーミングレスポンス対応
- ✅ ローディング表示
- ✅ チャットコピー機能（メッセージ単位/会話全体）
- ✅ 改行可能な入力欄（Shift+Enterで改行、Enterで送信）
- ✅ 記憶操作の使用例表示機能（ヘルプセクション）
- ✅ 入力欄の自動高さ調整
- ✅ コードブロック検出と自動フォーマット
- ✅ 言語別シンタックスハイライト
- ✅ コードブロック専用コピーボタン
- ✅ プロジェクトベースの会話管理

#### ファイルマネージャー
- ✅ ファイル・ディレクトリ一覧表示
- ✅ ファイル選択・オープン
- ✅ ファイル編集
- ✅ ファイル保存
- ✅ ファイル削除
- ✅ 新規ファイル・ディレクトリ作成
- ✅ 拡張ファイルマネージャーUIの実装
  - ✅ リスト/グリッド/詳細表示切替
  - ✅ ファイルタイプによるフィルタリング
  - ✅ ドラッグ＆ドロップ操作
  - ✅ コピー/切り取り/貼り付け操作
  - ✅ ファイルプロパティ表示
  - ✅ 複数ファイル選択
  - ✅ ショートカットキー対応
  - ✅ 視覚的に改善されたUI
  - ✅ コードの分割と最適化
  - ✅ Windows Explorer風UI
  - ✅ 右クリックコンテキストメニュー対応
  - ✅ フォルダツリーの実装
  - ✅ プロパティダイアログ（詳細情報表示）
  - ✅ キーボードナビゲーション（矢印キー対応）

#### UI コンポーネント
- ✅ Toastコンポーネント（通知機能）の実装
- ✅ Progressコンポーネント（進行状況表示）の実装
- ✅ Switchコンポーネントの実装
- ✅ Labelコンポーネントの実装
- ✅ Collapsibleコンポーネント（折りたたみパネル）の実装
- ✅ コードブロックフォーマットコンポーネント
- ✅ Cardコンポーネントの実装
- ✅ Tabsコンポーネントの実装
- ✅ Badgeコンポーネントの実装
- ✅ Textareaコンポーネントの実装
- ✅ Selectコンポーネントの実装
- ✅ Sliderコンポーネントの実装
- ✅ Tooltipコンポーネントの実装

#### 推論UI
- ✅ 推論ダッシュボードページ
- ✅ ステップバイステップ推論UI
- ✅ 文の真偽評価UI
- ✅ 選択肢比較UI
- ✅ 詳細レベル設定（low/medium/high）
- ✅ 結果のコピー機能
- ✅ プロセスと結果の可視化
- ✅ チャット形式での推論機能（複数回のやり取りが可能）
- ✅ 推論履歴の保存と表示

#### 高度なモデル活用ツール
- ✅ テキスト生成ツール
  - ✅ 複数の文書タイプ（創作、ビジネス、学術、技術）
  - ✅ 言語選択（日本語、英語、中国語、韓国語）
  - ✅ トーン調整（形式的、中立的、カジュアル、ユーモラス、専門的）
  - ✅ 長さ調整
  - ✅ ランダム性（温度）パラメータ調整
  - ✅ 思考プロセス表示オプション
  - ✅ コピーと保存機能
- ✅ データ分析ツール
  - ✅ テキスト要約機能
  - ✅ 感情分析機能
  - ✅ トピック抽出機能
  - ✅ キーワード抽出機能
  - ✅ 数値データ分析機能
  - ✅ ファイルアップロード対応（テキスト、CSV、JSON）
  - ✅ 分析結果のダウンロードとコピー機能

#### デザインシステム
- ✅ ダークモード/ライトモード対応
- ✅ モダンなUI設計
- ✅ レスポンシブデザイン
- ✅ 一貫したデザインシステム
- ✅ アクセシビリティ対応の改善
- ✅ サイドバーナビゲーション（折りたたみ可能）
- ✅ 視覚的なフィードバック機能

#### プロジェクト管理
- ✅ プロジェクト作成/削除機能
- ✅ プロジェクトベースのチャット履歴管理
- ✅ メインナビゲーションの実装
- ✅ プロジェクト一覧表示
- ✅ チャット履歴の永続化（ローカルストレージ）
- ✅ ホームから自動リダイレクト

#### システム
- ✅ エラーハンドリングの実装
- ✅ カスタム404ページ
- ✅ インストール手順のドキュメント

## 2. 未実装/開発中の機能

### 2.1 バックエンド API

#### コア機能
- ⏳ Hugging Face Transformersバックエンドの実装改善
- ⏳ モデル切り替え機能の強化
- ⏳ レスポンスのフォーマット設定オプション

#### ファイル操作機能
- ⏳ ファイル権限管理の強化
- ⏳ バイナリファイル対応の拡充
- ⏳ ファイル圧縮・解凍機能

#### GitHub連携機能
- ⏳ イシュー一覧取得
- ⏳ イシューコメント機能
- ⏳ コミット履歴取得
- ⏳ GitHub Actionsの操作

#### 推論機能
- ⏳ 推論過程の可視化強化

#### Web検索機能
- ⏳ 検索結果のフィルタリング
- ⏳ 検索ソースの多様化

#### メモリ管理機能
- ⏳ フロントエンド側でのセッション管理UI
- ⏳ 会話品質の自動評価
- ⏳ トレーニングデータのエクスポート/インポート
- ⏳ ユーザー定義記憶管理UIの実装

### 2.2 フロントエンド

#### チャットインターフェース
- ⏳ チャットセッション管理UI
- ⏳ チャットプロンプトテンプレート機能
- ⏳ モバイル表示最適化

#### ファイルマネージャー
- ⏳ ファイル検索UI
- ⏳ ファイル種類別表示フィルター

#### GitHub連携UI
- ⏳ リポジトリブラウザ
- ⏳ コード差分表示
- ⏳ イシュー・PR管理UI

#### 設定パネル
- ⏳ モデルパラメータ設定UI
- ⏳ API設定管理
- ⏳ UI表示カスタマイズ
- ⏳ メモリ設定管理UI

## 3. 技術的負債と課題

### 3.1 セキュリティ
- ⚠️ ファイルアクセス権限の強化
- ⚠️ API認証の改善
- ⚠️ 入力検証の徹底

### 3.2 パフォーマンス
- ⚠️ 大規模ファイル処理の最適化
- ✅ チャット履歴の効率的管理
- ✅ モデル推論速度の改善

### 3.3 UI/UX
- ✅ エラーハンドリングの改善
- ✅ フィードバックメカニズムの実装
- ✅ アクセシビリティ対応の強化

### 3.4 テスト
- ⚠️ 自動テストの拡充
- ⚠️ エンドツーエンドテストの実装
- ⚠️ エッジケースのカバレッジ向上

## 4. 今後の開発計画

### 4.1 短期（1-2週間）
- ✅ 既存バグの修正
- 🔜 基本的なセキュリティ強化
- ✅ UIの使いやすさ改善
- ✅ メモリ機能の実装
- ✅ ユーザー定義記憶機能の実装
- ✅ 記憶操作機能の拡充
- ✅ チャットUIの使いやすさ向上
- ✅ 推論機能の実装とUIの整備
- ✅ コードブロック検出と強化表示機能の追加
- ✅ 推論機能の高度化
- ✅ モデル活用高度ツールの実装
- ✅ UIデザインの大幅改善
- ✅ プロジェクト管理機能の実装
- ✅ チャット履歴の管理
- ✅ インストール手順の文書化

### 4.2 中期（1-2ヶ月）
- 🔜 GitHub連携UIの実装
- ✅ チャット履歴管理機能
- ✅ ファイルマネージャーの拡張
- 🔜 事後学習データの活用
- 🔜 ユーザー定義記憶の管理UI実装
- ✅ 推論機能の高度化
- 🔜 コード実行環境の統合

### 4.3 長期（3-6ヶ月）
- 🔜 マルチモデル対応
- 🔜 プラグイン機能
- 🔜 高度なファイル解析ツール統合
- 🔜 コード実行環境の統合

## 5. 環境設定状況

### 5.1 必要な環境変数
- `USE_OLLAMA`: Ollamaを使用するかどうか（デフォルト: True）
- `OLLAMA_BASE_URL`: Ollama APIのURL（デフォルト: http://localhost:11434）
- `OLLAMA_MODEL_NAME`: 使用するモデル名（デフォルト: gemma3:27b）
- `MAX_NEW_TOKENS`: 生成する最大トークン数
- `DEFAULT_TEMPERATURE`: 生成のランダム性（低いほど決定論的）
- `DEFAULT_TOP_P`: 確率分布のパーセンタイルしきい値
- `DEFAULT_TOP_K`: 次のトークン候補数
- `GITHUB_API_TOKEN`: GitHub API認証トークン
- `API_AUTH_TOKEN`: API認証トークン（オプション）
- `API_AUTH_REQUIRED`: API認証が必要かどうか（デフォルト: False）

### 5.2 依存関係
- Python 3.10以上
- Node.js 20.0.0以上
- Ollama（最新版）
- Gemma 3モデル（事前ダウンロード）
- SQLite3（メモリ機能用）
- Radix UI依存関係（フロントエンド用）

## 6. 注意事項とTips

### 6.1 ファイル操作
- セキュリティのため、デフォルトでは特定ディレクトリのみアクセス可能
- アクセス可能パスは`api/app/routers/file_operations.py`の`ALLOWED_DIRS`で設定
- 初期アクセス先はWindowsの場合はC:ドライブに設定しています
- フロントエンドのファイルマネージャーの初期パスは空文字列に設定（APIサーバー側でデフォルトパスを使用）

### 6.2 モデル設定
- モデルのパラメータは`.env`ファイルで調整可能
- より高品質な応答には温度（temperature）を下げる（0.2-0.4推奨）
- 創造的な応答には温度を上げる（0.7-0.9推奨）
- TOP_PとTOP_Kも推論品質に大きく影響します

### 6.3 開発環境
- APIサーバーはデバッグモードで起動するとホットリロード対応
- フロントエンドはNext.jsのdev実行で自動リロード対応
- コード変更時はブラウザのキャッシュをクリアすると安全
- 詳細なインストール手順は`dashboard/INSTALL.md`を参照してください

### 6.4 主要なディレクトリ構造
```
./
├── api/                  # Python FastAPI サーバー
│   ├── app/              # API アプリケーション
│   │   ├── core/         # 設定、依存関係等
│   │   ├── models/       # モデル関連
│   │   └── routers/      # API エンドポイント
│   ├── data/             # データベースファイル（メモリ機能）
└── dashboard/            # Next.js チャットインターフェース
    ├── src/              # ソースコード
    │   ├── app/          # ページコンポーネント
    │   │   ├── chat/     # チャットプロジェクトページ
    │   │   ├── projects/ # プロジェクト管理ページ
    │   │   ├── reasoning/# 推論ツールページ
    │   │   └── tools/    # モデル活用ツール
    │   ├── components/   # UI コンポーネント
    │   │   ├── FileManager/ # ファイルマネージャーコンポーネント
    │   │   │   ├── components/ # 分割されたコンポーネント
    │   │   │   ├── hooks/      # カスタムフック
    │   │   │   └── types.ts    # 型定義
    │   │   ├── Navigation/ # ナビゲーションコンポーネント
    │   │   ├── Reasoning/  # 推論UIコンポーネント
    │   │   ├── theme/      # テーマ関連コンポーネント
    │   │   └── ui/         # 基本UIコンポーネント
    │   └── lib/           # ユーティリティ
    │       └── services/  # サービスクラス
```

## 7. 最近の更新内容

### 7.1 推論機能のチャット形式への改修 (2025-03-15)
- ✅ 3つの推論機能（ステップバイステップ推論、文の真偽評価、選択肢比較）すべてをチャット形式に改修
- ✅ 複数回のやり取りが可能なインターフェースを実装（質問を送信→回答が返ってくる→再度質問を送信→回答が返ってくる...）
- ✅ 推論履歴の保存と表示機能を追加
- ✅ 過去の推論結果とのやり取りのコンテキストを保持
- ✅ メッセージコピー機能の追加
- ✅ 自動スクロール機能の実装
- ✅ 入力フォームの高さ自動調整
- ✅ ショートカットキー対応（Shift+Enterで改行、Enterで送信）
- ✅ 初回表示時のガイダンス表示
- ✅ ローディング表示の改善

### 7.2 依存関係とインストール文書の充実 (2025-03-15)
- ✅ Radix UI依存関係を追加（@radix-ui/react-sliderなど）
- ✅ package.jsonファイルを更新し必要なパッケージを明示
- ✅ 詳細なインストール手順書（INSTALL.md）を作成
- ✅ 環境構築の簡略化と統一化
- ✅ トラブルシューティング情報の追加

### 7.3 UX改善とページナビゲーションの強化 (2025-03-15)
- ✅ ホームページからプロジェクト一覧へ自動リダイレクト機能を追加
- ✅ カスタム404ページを実装しユーザー体験を向上
- ✅ ナビゲーションの一貫性とアクセシビリティを改善
- ✅ エラー状態のフィードバックを強化

### 7.4 プロジェクト管理とチャット履歴機能の実装 (2025-03-15)
- ✅ プロジェクト作成・管理・削除機能を実装
- ✅ プロジェクトごとのチャット履歴保存機能を実装
- ✅ プロジェクト一覧ページの追加
- ✅ プロジェクトベースのチャットページの追加
- ✅ チャット履歴の永続化（ローカルストレージに保存）
- ✅ メインナビゲーションコンポーネントの実装
- ✅ 最近の更新順/作成日順の表示切替機能
- ✅ プロジェクトカードUI実装
- ✅ 直感的なUIで使いやすいプロジェクト管理を実現

### 7.5 推論機能のAPI接続強化 (2025-03-15)
- ✅ reasoning-service.tsのAPI接続方法を改善
- ✅ URLの構築方法を固定値に変更し接続の安定性を向上
- ✅ エラーハンドリングを強化し、詳細なエラー情報を表示
- ✅ デバッグ情報の出力を追加
- ✅ エラーレスポンスの解析処理を改善
- ✅ 推論機能の全体的な信頼性を向上

### 7.6 チャットUIからファイルマネージャーUIの削除 (2025-03-15)
- ✅ メインチャットページからファイルマネージャーUIを削除
- ✅ 不要なファイルマネージャー関連のstate・関数を削除
- ✅ UIをシンプルで使いやすく整理
- ✅ ファイルマネージャー機能は個別ページとして分離予定

### 7.7 UIコンポーネントのTypeScript/JSX対応修正 (2025-03-15)
- ✅ `use-toast.ts`を`use-toast.tsx`に変更しJSX構文の互換性を修正
- ✅ UIコンポーネントに`use client`ディレクティブを追加
- ✅ クライアントコンポーネントをNext.js 14の要件に対応
- ✅ TypeScriptファイル拡張子を適切に設定し、JSXを含むファイルには`.tsx`を使用
- ✅ ソースコードの一貫性を向上させファイル構造を整理

### 7.8 ファイルマネージャーのテーマ対応改善 (2025-03-15)
- ✅ ファイルマネージャーUIのダークモード対応を修正
- ✅ 背景色と文字色を適切なテーマ変数に変更
- ✅ `bg-white`から`bg-background`に変更
- ✅ カード背景を`bg-card`に変更
- ✅ テキストを`text-foreground`に変更し視認性を確保
- ✅ ダークモードでの文字が見えない問題を解決

### 7.9 モダンUI設計とダークモード対応 (2025-03-15)
- ダークモード/ライトモード切り替え機能を実装
- テーマプロバイダーコンポーネントを追加
- テーマ切り替えボタンをヘッダーに統合
- 折りたたみ可能なサイドバーナビゲーションを実装
- モバイル表示に対応したレスポンシブデザイン
- 一貫したデザインシステムの適用
- アクセシビリティを考慮したUI要素の実装
- 視覚的なフィードバック機能の強化

### 7.10 高度なモデル活用ツールの実装 (2025-03-15)
- テキスト生成ツールページを実装
  - 様々な文書タイプ、言語、トーン、長さ調整機能
  - 温度（ランダム性）パラメータのスライダー制御
  - タブ切り替えによる入力と出力の管理
- データ分析ツールページを実装
  - 多様な分析タイプ（要約、感情分析、トピック抽出など）
  - ファイルアップロード機能（テキスト、CSV、JSON対応）
  - 分析結果のダウンロードとコピー機能
- モデルパラメータの最適化による高品質な結果の提供
- 高度なUI/UXデザインの適用

### 7.11 UIコンポーネントライブラリの拡充 (2025-03-15)
- 新たなUIコンポーネントの追加：
  - Card: 情報をグループ化して表示
  - Tabs: コンテンツの切り替え表示
  - Badge: ステータスやカテゴリの視覚的表示
  - Textarea: 複数行テキスト入力
  - Select: ドロップダウン選択
  - Slider: 数値範囲の調整
- 既存コンポーネントの改良と最適化
- アクセシビリティ対応の強化（キーボードナビゲーション、スクリーンリーダー対応）
- レスポンシブデザインの徹底

### 7.12 推論能力の大幅向上 (2025-03-15)
- 推論機能の確信度と推論品質を大幅に向上（確信度50%→80-90%、品質low→medium/high）
- 推論プロンプトを強化し、より詳細で正確な思考プロセスを実現
- 確信度の言語的表現を追加（「非常に高い」「高い」「中程度」「不確か」「低い」）
- ステップバイステップ推論における思考ステップの質と量を改善
- 推論パラメータを最適化:
  - DEFAULT_TEMPERATURE: 0.7→0.3（より決定論的な応答を生成）
  - DEFAULT_TOP_P: 0.9→0.95（より高品質なトークン選択）
  - DEFAULT_TOP_K: 50→40（より高品質な次トークン候補を選択）
- 現在の日付情報をモデルに提供して時間的コンテキストを強化
- フォールバック処理の改善（JSONパース失敗時の確信度を75%に設定）
- 詳細レベルごとの評価ポイント数と根拠数を増加

### 7.13 コードブロック検出と強化表示機能の追加 (2025-03-15)
- チャットメッセージ内のコードブロックを自動検出し、専用フォーマットで表示する機能を実装
- ```language\ncode``` 形式のマークダウンコードブロックに対応
- 言語名を表示し、コードを見やすくフォーマット
- コードブロック専用のコピーボタンを追加して操作性を向上
- コード部分と通常テキスト部分を視覚的に区別しやすく表示
- 以下のコンポーネントを作成:
  - MessageContent.tsx - コードブロック検出とフォーマット機能を提供
  - CodeBlock.tsx - コードブロックのレンダリングとコピー機能
- 既存のチャットインターフェースを更新し、新機能を統合
- クラス名の条件付き組み合わせのための cn ユーティリティ関数を追加

### 7.14 テーマトグルコンポーネントのインポートパス修正 (2025-03-15)
- MainNav.tsxのインポートパスを修正
- 相対パス`../theme/mode-toggle`から絶対パス`@/components/theme/mode-toggle`に変更
- Next.jsのモジュール解決問題を解決
- エラー「Module not found: Can't resolve '../theme/mode-toggle'」を解消
- プロジェクトの安定した動作を確保

### 7.15 ダークモード時のテキスト表示問題修正とパッケージ追加 (2025-03-15)
- ✅ ダークモード時にチャットメッセージのテキストが見えない問題を修正
- ✅ `MessageContent`コンポーネントのテキスト色を`text-current`に変更しテーマ自動継承に対応
- ✅ アシスタントのメッセージに明示的に`text-card-foreground`クラスを追加
- ✅ `@radix-ui/react-progress`パッケージを追加して進捗表示コンポーネントの依存関係を解決
- ✅ アシスタントの応答とユーザー入力の両方でテキスト表示の一貫性を確保
- ✅ チャットUIの全体的な可読性と使いやすさを向上

### 7.16 推論機能のJSON解析エラー修正 (2025-03-15)
- ✅ 推論結果の処理中に発生するJSONパースエラー(`line 2 column 7 (char 8)`)を修正
- ✅ `clean_json_string`メソッドを追加し、不適切な形式のJSONを自動修正する機能を実装
- ✅ プロパティ名のダブルクォーテーション強制機能を追加
- ✅ シングルクォートをダブルクォートに変換する処理を追加
- ✅ 不要なカンマやフォーマット問題を修正する正規表現処理を追加
- ✅ システムプロンプトでJSONフォーマットの重要性について強調するよう修正
- ✅ 詳細なエラーログ記録を追加して問題の診断を容易に
- ✅ エラー箇所の周辺コンテキストをログに残す機能を追加
- ✅ クリーンアップ後もJSONパースに失敗した場合の適切なフォールバック処理を追加
- ✅ 全ての推論タイプ（ステップバイステップ、文の評価、選択肢比較）に対応
